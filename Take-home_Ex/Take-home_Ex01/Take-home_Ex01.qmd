---
title: "Take-home_Ex01"
---

Installing relevant R packages

```{r}
#install.packages("spatstat", dependencies = TRUE)
#install.packages("maptools", repos = "https://packagemanager.posit.co/cran/2023-10-13")

pacman::p_load(arrow, classInt, ggplot2, lubridate, maptools, raster, sf, spatstat, sp, spNetwork, tidyverse, tmap, viridis)

crs_svy21 <- "EPSG:3414"
```

Importing Aspatial Data (GrabPosisi)

```{r}
grabdata <- read_parquet("D:/Kabeer2003/IS415 - GAA/Take-Home_Ex/Take-Home_Ex01/data/aspatial/GrabPosisi/part-00000.parquet")

```

Importing Spatial Data 

```{r}
map_sf <- st_read("D:/Kabeer2003/IS415 - GAA/Take-Home_Ex/Take-Home_Ex01/data/geospatial/MasterPlan2019SubzoneBoundaryNoSeaGEOJSON.geojson")
map_sf <- st_zm(map_sf, drop = TRUE)
map_sf <- st_transform(map_sf, crs_svy21)

```

Importing Aspatial Data

```{r}
roads_sf <- st_read("D:/Kabeer2003/IS415 - GAA/Take-Home_Ex/Take-Home_Ex01/data/geospatial/singapore_roads.gpkg")
roads_sf <- st_transform(roads_sf, crs_svy21)

roads_sf <- roads_sf %>% filter(fclass %in% c("primary", "secondary", "tertiary", "motorway", "trunk"), !is.na(name))


```



```{r}
map_sf <- st_make_valid(map_sf)

sgmap_sf <- map_sf %>%
  st_union()

```

Similarly, finding points of destination for each trip by setting the index to (n)

```{r}
trips_by_destination_pts <- grabdata %>%
  group_by(trj_id) %>%
  slice(n()) %>%
  filter(speed <= 1 && speed >= -1) %>%  
  select(trj_id, latitude = rawlat, longitude = rawlng, speed)

```

Converting the map to an owin object

```{r}
sgmap_owin <- as.owin(sgmap_sf)

plot(sgmap_owin)
summary(sgmap_owin)
```



Converting aspatial data (trips by destination points) to the ppp format to plot kernel density later. An owin window using the Geographical coordinates of Singapore has been used to derive package all points. 

```{r}
map_window <- owin(c(103.55, 104.10), c(1.15, 1.47))

trips_by_destination_pts_ppp <- ppp(x = trips_by_destination_pts$longitude,
                                     y = trips_by_destination_pts$latitude,
                                     window = map_window)

trips_by_destination_pts_ppp$marks <- trips_by_destination_pts$trj_id
summary(trips_by_destination_pts_ppp)
```

Eliminating redundancies via Jittering (None removed as no redundancies exist in this dataset)

```{r}
any(duplicated(trips_by_destination_pts_ppp))

trips_by_destination_pts_ppp <- rjitter(trips_by_destination_pts_ppp, retry = TRUE, nsim = 1, drop = TRUE)

any(duplicated(trips_by_destination_pts_ppp))
```

Binding the ppp data structure to the owin map of Singapore

```{r}
#trips_by_destination_pts_ppp = trips_by_destination_pts_ppp[sgmap_owin]
```

Plotting the points on a map. This is a map depicting the different drop-off / destination points across Singapore. Upon conducting a visual inspection on the map, it is imperative that the CBD is a popular destination for grab passengers indicating that most passengers use Grab to travel to their office in time. THis would further be emperically proven using the kernel density of different regions across Singapore subsequently

```{r}
trips_by_destination_pts_new <- st_as_sf(trips_by_destination_pts, 
                                        coords = c("longitude", "latitude"))

tmap_mode('view')
tm_shape(map_sf) +
  tm_borders() + 
  tm_shape(roads_sf) +
  tm_lines() +
  tm_shape(trips_by_destination_pts_new) +
  tm_dots()

```

Plotting Kernel Density 

```{r}
trips_by_destination_diggle <- ppp(trips_by_destination_pts_ppp$lon, trips_by_destination_pts_ppp$lat, window = sgmap_owin)
summary(trips_by_destination_diggle)
```

Plotting Kernel Density

```{r}
#bw_diggle <- bw.diggle(trips_by_destination_diggle)

#trips_by_destination_diggle <- density(trips_by_destination_diggle, sigma = 2 * as.numeric(bw.diggle), edge = TRUE, kernel = "gaussian")



#plot(trips_by_destination_diggle, main = "bw.diggle")

```



Planned approach

Transform aspatial data (Follow In-class Exercise 2)

Plot on map using NKDE (Owin objects thingy) (Follow In-class Exercise 3)


